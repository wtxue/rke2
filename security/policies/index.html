
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/favicon-32x32.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.2">
    
    
      
        <title>Default Policy Configuration - RKE2 - Rancher's Next Generation Kubernetes Distribution</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f72e892.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Work Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pod-security-policies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="RKE2 - Rancher&#39;s Next Generation Kubernetes Distribution" class="md-header-nav__button md-logo" aria-label="RKE2 - Rancher's Next Generation Kubernetes Distribution">
      
  <img src="../../assets/logo-stacked-white-rke2.svg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            RKE2 - Rancher's Next Generation Kubernetes Distribution
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Default Policy Configuration
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/rancher/rke2/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="RKE2 - Rancher&#39;s Next Generation Kubernetes Distribution" class="md-nav__button md-logo" aria-label="RKE2 - Rancher's Next Generation Kubernetes Distribution">
      
  <img src="../../assets/logo-stacked-white-rke2.svg" alt="logo">

    </a>
    RKE2 - Rancher's Next Generation Kubernetes Distribution
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/rancher/rke2/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Installation
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Installation" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Installation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/quickstart/" class="md-nav__link">
      Quick Start
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/requirements/" class="md-nav__link">
      Requirements
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/ha/" class="md-nav__link">
      High Availability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Install Options
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Install Options" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        <span class="md-nav__icon md-icon"></span>
        Install Options
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install_options/install_options/" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install_options/server_config/" class="md-nav__link">
      Server Configuration Reference
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/install_options/agent_config/" class="md-nav__link">
      Agent Configuration Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/methods/" class="md-nav__link">
      Installation Methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/network_options/" class="md-nav__link">
      Network Options
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/containerd_registry_configuration/" class="md-nav__link">
      Containerd Registry Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/airgap/" class="md-nav__link">
      Air-Gap Install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../install/uninstall/" class="md-nav__link">
      Uninstall
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Upgrades
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Upgrades" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Upgrades
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../upgrade/upgrade/" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../upgrade/basic_upgrade/" class="md-nav__link">
      Upgrade Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../upgrade/automated_upgrade/" class="md-nav__link">
      Automated Upgrades
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Security
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Security" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../hardening_guide/" class="md-nav__link">
      CIS Hardening Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cis_self_assessment/" class="md-nav__link">
      CIS Self-Assessment Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fips_support/" class="md-nav__link">
      FIPS 140-2 Enablement
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Default Policy Configuration
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Default Policy Configuration
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pod-security-policies" class="md-nav__link">
    Pod Security Policies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policies" class="md-nav__link">
    Network Policies
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../selinux/" class="md-nav__link">
      SELinux
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Architecture
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Architecture" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../architecture/architecture/" class="md-nav__link">
      Anatomy of a Next Generation Kubernetes Distribution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../cluster_access/" class="md-nav__link">
      Cluster Access
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../backup_restore/" class="md-nav__link">
      Etcd Backup and Restore
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../networking/" class="md-nav__link">
      Networking
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../helm/" class="md-nav__link">
      Helm Integration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../advanced/" class="md-nav__link">
      Advanced Options and Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../known_issues/" class="md-nav__link">
      Known Issues and Limitations
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pod-security-policies" class="md-nav__link">
    Pod Security Policies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policies" class="md-nav__link">
    Network Policies
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/rancher/rke2/edit/master/docs/security/policies.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Default Policy Configuration</h1>
                
                <p>This document describes how RKE2 configures PodSecurityPolicies and NetworkPolicies in order to be secure-by-default while also providing operators with maximum configuration flexibility.</p>
<h4 id="pod-security-policies">Pod Security Policies<a class="headerlink" href="#pod-security-policies" title="Permanent link">&para;</a></h4>
<p>RKE2 can be ran with or without the <code>profile: cis-1.5</code> configuration parameter. This will cause it to apply different PodSecurityPolicies (PSPs) at start-up.</p>
<ul>
<li>If ran with the <code>cis-1.5</code> profile, RKE2 will apply a restrictive policy called <code>global-restricted-psp</code> to all namespaces except <code>kube-system</code>. The <code>kube-system</code> namespace needs a less restrictive policy named <code>system-unrestricted-psp</code> in order to launch critical components.</li>
<li>If ran without the <code>cis-1.5</code> profile, RKE2 will apply a completely unrestricted policy called <code>global-unrestricted-psp</code>, which is the equivalent of running without the PSP admission controller enabled.</li>
</ul>
<p>RKE2 will put these policies in place upon initial startup, but will not modify them after that, unless explicitly triggered by the cluster operator as described below. This is to allow the operator to fully control the PSPs without RKE2's defaults adding interference.</p>
<p>Creation and application of the PSPs is controlled by the presence or absence of certain annotations on the <code>kube-system</code> namespace. These map directly to the PSPs which can be created and are:</p>
<ul>
<li><code>psp.rke2.io/global-restricted</code></li>
<li><code>psp.rke2.io/system-unrestricted</code></li>
<li><code>psp.rke2.io/global-unrestricted</code></li>
</ul>
<p>The following logic is performed at startup for the policies and their annotations:</p>
<ul>
<li>If the annotation exists, RKE2 continues without further action.</li>
<li>If the annotation doesn't exist, RKE2 checks to see if the associated policy exists and if so, deletes and recreates it, along with adding the annotation to the namespace.</li>
<li>In the case of the <code>global-unrestricted-psp</code>, the policy is not recreated. This is to account for moving between CIS and non-CIS modes without making the cluster less secure.</li>
<li>At the time of creating a policy, cluster roles and cluster role bindings are also created to ensure the appropriate policies are put into use by default.</li>
</ul>
<p>So, after initial start-up, operators can modify or delete RKE2's policies and RKE2 will respect those changes. Additionally, to "reset" a policy, an operator just needs to delete the associated annotation from the <code>kube-system</code> namespace and restart RKE2.</p>
<p>The policies are outlined below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PodSecurityPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global-restricted-psp</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span><span class="p">:</span> <span class="s">&#39;docker/default,runtime/default&#39;</span>
    <span class="nt">apparmor.security.beta.kubernetes.io/allowedProfileNames</span><span class="p">:</span> <span class="s">&#39;runtime/default&#39;</span>
    <span class="nt">seccomp.security.alpha.kubernetes.io/defaultProfileName</span><span class="p">:</span> <span class="s">&#39;runtime/default&#39;</span>
    <span class="nt">apparmor.security.beta.kubernetes.io/defaultProfileName</span><span class="p">:</span> <span class="s">&#39;runtime/default&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>                <span class="c1"># CIS - 5.2.1</span>
  <span class="nt">allowPrivilegeEscalation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>  <span class="c1"># CIS - 5.2.5</span>
  <span class="nt">requiredDropCapabilities</span><span class="p">:</span>        <span class="c1"># CIS - 5.2.7/8/9</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ALL</span>
  <span class="nt">volumes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;configMap&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;emptyDir&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;projected&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;secret&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;downwardAPI&#39;</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;persistentVolumeClaim&#39;</span>
  <span class="nt">hostNetwork</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>               <span class="c1"># CIS - 5.2.4</span>
  <span class="nt">hostIPC</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>                   <span class="c1"># CIS - 5.2.3</span>
  <span class="nt">hostPID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>                   <span class="c1"># CIS - 5.2.2</span>
  <span class="nt">runAsUser</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;MustRunAsNonRoot&#39;</span>       <span class="c1"># CIS - 5.2.6</span>
  <span class="nt">seLinux</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">supplementalGroups</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;MustRunAs&#39;</span>
    <span class="nt">ranges</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">min</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="nt">max</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="nt">fsGroup</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;MustRunAs&#39;</span>
    <span class="nt">ranges</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">min</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="nt">max</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="nt">readOnlyRootFilesystem</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>

<p>If RKE2 is started in non CIS mode, annotations are checked like above however the resulting application of pod security policies is a permissive one. See below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PodSecurityPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global-unrestricted-psp</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span><span class="p">:</span> <span class="s">&#39;*&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">allowPrivilegeEscalation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">allowedCapabilities</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;*&#39;</span>
  <span class="nt">volumes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;*&#39;</span>
  <span class="nt">hostNetwork</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">hostPorts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">min</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="nt">max</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="nt">hostIPC</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">hostPID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">runAsUser</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">seLinux</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">supplementalGroups</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">fsGroup</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
</code></pre></div>

<p>In both cases, the "system unrestricted policy" is applied. See below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PodSecurityPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">system-unrestricted-psp</span>
  <span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span><span class="p">:</span> <span class="s">&#39;*&#39;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">allowPrivilegeEscalation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">allowedCapabilities</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;*&#39;</span>
  <span class="nt">volumes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;*&#39;</span>
  <span class="nt">hostNetwork</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">hostPorts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">min</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="nt">max</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="nt">hostIPC</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">hostPID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">runAsUser</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">seLinux</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">supplementalGroups</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
  <span class="nt">fsGroup</span><span class="p">:</span>
    <span class="nt">rule</span><span class="p">:</span> <span class="s">&#39;RunAsAny&#39;</span>
</code></pre></div>

<p>To view the podSecurityPolicies currently deployed on your system, run the below command:</p>
<div class="codehilite"><pre><span></span><code>kubectl get psp -A
</code></pre></div>

<h4 id="network-policies">Network Policies<a class="headerlink" href="#network-policies" title="Permanent link">&para;</a></h4>
<p>When RKE2 is run with the <code>profile: cis-1.5</code> parameter, it will apply 2 network policies to the <code>kube-system</code>, <code>kube-public</code>, and <code>default</code> namespaces and applies associated annotations. The same logic applies to these policies and annotations as the PSPs. On start, the annotations for each namespace are checked for existence and if they exist, RKE2 takes no action. If the annotation doesn't exist, RKE2 checks to see if the policy exists and if it does, recreates it.</p>
<p>The first policy applied is to restrict network traffic to only the namespace itself. See below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">managedFields</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
    <span class="nt">fieldsType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FieldsV1</span>
    <span class="nt">fieldsV1</span><span class="p">:</span>
      <span class="l l-Scalar l-Scalar-Plain">f:spec</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">f:ingress</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
        <span class="l l-Scalar l-Scalar-Plain">f:policyTypes</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default-network-policy</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ingress</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">from</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">podSelector</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">podSelector</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">policyTypes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</code></pre></div>

<p>The second policy applied is to the <code>kube-system</code> namespace and allows for DNS traffic. See below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">managedFields</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
    <span class="nt">fieldsV1</span><span class="p">:</span>
      <span class="l l-Scalar l-Scalar-Plain">f:spec</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">f:ingress</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
        <span class="l l-Scalar l-Scalar-Plain">f:podSelector</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">f:matchLabels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">f:policyTypes</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default-network-dns-policy</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ingress</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
      <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>
      <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
  <span class="nt">podSelector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
  <span class="nt">policyTypes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
</code></pre></div>

<p>RKE2 applies the <code>default-network-policy</code> policy and <code>np.rke2.io</code> annotation to all built-in namespaces. The <code>kube-system</code> namespace additionally gets the <code>default-network-dns-policy</code> policy and <code>np.rke2.io/dns</code> annotation applied to it.</p>
<p>To view the network policies currently deployed on your system, run the below command:</p>
<div class="codehilite"><pre><span></span><code>kubectl get networkpolicies -A
</code></pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../fips_support/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                FIPS 140-2 Enablement
              </div>
            </div>
          </a>
        
        
          <a href="../selinux/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                SELinux
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../../assets/javascripts/bundle.9554a270.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>